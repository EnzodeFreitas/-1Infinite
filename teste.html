<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Calendar Heatmap estilo GitHub - Dinâmico</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
  </style>
</head>

<body>
<canvas id="myChart1" width="600" height="300"></canvas>
  <script>
   function obterDadosGrafico(id) {
    if (proximaAtualizacao != undefined) {
        clearTimeout(proximaAtualizacao);
    }

    fetch(`/rotas/dados/${id}`, { cache: 'no-store' })
        .then(response => {
            if (response.ok) {
                response.json().then(resposta => {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse(); // Opcional: do mais recente para o mais antigo
                    plotarGrafico(resposta, id);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
        .catch(error => {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
}


function plotarGrafico(resposta, id) {
    console.log('Iniciando plotagem do gráfico...');

    // Extrai datas e distâncias do banco
    const labels = resposta.map(item => item.date_current);
    const distancias = resposta.map(item => item.distance);

    const data = {
        labels: labels,
        datasets: [
            {
                label: 'Distância Total (km)',
                data: distancias,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                tension: 0.3,
                fill: true,
                pointRadius: 4,
                pointBackgroundColor: '#36A2EB'
            }
        ]
    };

    const config = {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Evolução da Distância por Dia'
                },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.parsed.y} km`
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Data'
                    },
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: 10
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Distância (km)'
                    }
                }
            }
        }
    };

    const canvasId = `myChart${id}`;
    const ctx = document.getElementById(canvasId).getContext('2d');
    new Chart(ctx, config);
}
  </script>
</body>

</html>
