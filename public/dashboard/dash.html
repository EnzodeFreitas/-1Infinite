<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | -1Infinite</title>
    <!-- Biblioteca para ícone -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">
    <!-- Bibliteca particle.js -->
    <link rel="stylesheet" href="./css/dash.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Biblioteca D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
    </style>
</head>

<body class="page-fade-in">
    <!-- SIDE -->
    <div class="side">
        <ul class="social">
            <li class="social-item"><a href="../map.html"><i class="bx bx-arrow-back"></i></a></li>
        </ul>
    </div>
    <h1 class="titulo-principal">Análise das Rotas e Ferramentas Utilizadas</h1>
    <div class="separator"></div>
    <div class="graficos">
        <div class="grafico-container">
            <div class="kpi">
                <span>🌍 Total de rotas: <strong>26</strong></span>
            </div>
            <canvas id="myChart"></canvas>
        </div>
        <div class="grafico-container">
            <div class="kpi">
                <span>📍 Ferramenta Mais Usada: <strong>Retângulo</strong></span>
            </div>
            <canvas id="myChart2"></canvas>
        </div>
        <div class="grafico-container">
            <div class="kpi">
                <span>🔥 Intensidade de uso por dias <strong></strong></span>
            </div>
            <div id="heatmap"></div>
        </div>
    </div>

    <script>
        // SETUP 
        // LABELS FIXOS PARA CADA HORÁRIO

        // GRÁFICO LINHAS - QUANTIDADE DE ROTAS POR FAIXA DE DISTÂNCIA
        const labels = ['0–1 km', '1–2 km', '2–3 km', '3–4 km', '4–5 km'];

        // GRÁFICO BARRAS X FERRAMENTAS
        const labels2 = ['Rota', 'Polígono criativo', 'Retângulo', 'Circunferência', 'Marcador', 'Marcador em Área'];

        // DADOS FIXOS
        // GRÁFICO LINHAS
        const data = {
            labels: labels,
            datasets: [
                {
                    // Dados da quantidade de rotas
                    label: 'Quantidade de Rotas',
                    data: [5, 12, 9, 3, 1], // Número de rotas que caíram em cada faixa de distância
                    borderColor: 'blue',
                    backgroundColor: 'rgba(0, 0, 255, 0.5)',
                    yAxisID: 'y',
                    tension: 0.3
                }
            ]
        };

        // GRÁFICO BARRAS
        const data2 = {
            labels: labels2,
            datasets: [
                {
                    // Dados da quantidade de ferramentas
                    label: 'Quantidade',
                    data: [22, 24, 27, 23, 20, 18],
                    borderColor: 'red',
                    borderWidth: 2.5,
                    backgroundColor: 'rgba(255, 0, 0, 0.5)',
                    yAxisID: 'y',
                    tension: 0
                },
            ]
        };

        // CONFIG - GRÁFICO LINHAS
        const config = {
            type: 'line', // Tipo de gráfico: linha
            data: data, // Dados a serem exibidos
            options: {
                responsive: true, // Faz o gráfico se ajustar ao tamanho da tela
                interaction: {
                    mode: 'index', // Interação no gráfico em modo índice
                    intersect: false, // Não precisa intersectar as linhas
                },
                stacked: false, // Não permitir que as linhas fiquem empilhadas
                plugins: {
                    title: {
                        display: true, // Exibe o título
                        text: 'Número de Rotas por Faixa de Distância' // Texto do título
                    }
                },
                scales: {
                    // === EIXO X ===
                    x: {
                        title: {
                            display: true, // Exibe o título do eixo X
                            text: 'Faixa de Distância (km)' // Texto do título
                        }
                    },
                    // === EIXO Y ===
                    y: {
                        type: 'linear', // Tipo do eixo Y: linear (numérico)
                        display: true, // Exibe o eixo Y
                        position: 'left', // Posição do eixo  
                        min: 0, // Valor mínimo 
                        max: 15, // Valor máximo
                        ticks: {
                            stepSize: 3 // Define o tamanho do incremento (0, 3, 6...)
                        },
                        title: {
                            display: true, // Exibe o título do eixo 
                            text: 'Quantidade de rotas'
                        }
                    },
                }
            },
        };

        // CONFIG - GRÁFICO DE BARRAS
        const config2 = {
            type: 'bar', // Gráfico de barras
            data: data2,
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Ferramentas utilizadas'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Formas'
                        }
                    },
                    y: { // ===== Y FERRAMENTAS =====//
                        type: 'linear',
                        display: true,
                        position: 'left',
                        min: 0,
                        max: 40,
                        ticks: {
                            stepSize: 5
                        },
                        title: {
                            display: true,
                            text: 'Quantidade'
                        }
                    },
                }
            }
        };

        // CRIANDO O GRÁFICO DE LINHAS
        const myChart = new Chart(
            document.getElementById('myChart'), // O canvas onde o gráfico será desenhado
            config // A configuração do gráfico de linha
        );

        // CRIANDO O GRÁFICO DE BARRAS
        const myChart2 = new Chart(
            document.getElementById('myChart2'),
            config2
        );

        // ===== CALENDAR HEATMAP =====
        const year = new Date().getFullYear();
        const width = 1000, height = 150, cellSize = 17;
        const svg = d3.select("#heatmap").append("svg")
            .attr("width", width)
            .attr("height", height);
        const g = svg.append("g").attr("transform", "translate(40,20)");
        const color = d3.scaleQuantize()
            .domain([0, 10])
            .range(["#050f1a", "#c6e48b", "#7bc96f", "#239a3b", "#196127"]);
        const dayLabels = ["D", "S", "T", "Q", "Q", "S", "S"];
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip").style("opacity", 0);

        g.selectAll(".day-label")
            .data(dayLabels)
            .join("text")
            .attr("class", "day-label")
            .attr("x", -5)
            .attr("y", (d, i) => i * cellSize + 12)
            .attr("text-anchor", "end")
            .text(d => d);

        g.selectAll(".month")
            .data(d3.timeMonths(new Date(year, 0, 1), new Date(year + 1, 0, 1)))
            .join("text")
            .attr("class", "month-label") // Classe para estilizar
            .attr("x", d => d3.timeWeek.count(d3.timeYear(d), d) * cellSize)
            .attr("y", -5)
            .text(d3.timeFormat("%b"));

        const allDates = d3.timeDays(new Date(year, 0, 1), new Date(year + 1, 0, 1));
        let heatmapData = allDates.map(d => ({ date: d, value: 0 }));

        function formatDate(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function updateHeatmap() {
            const stored = JSON.parse(localStorage.getItem('userActivityByDate'));
            heatmapData.forEach(d => {
                const key = formatDate(d.date);
                d.value = stored[key] || 0;
            });

            g.selectAll("rect.day")
                .data(heatmapData, d => formatDate(d.date))
                .join(
                    enter => enter.append("rect")
                        .attr("class", "day")
                        .attr("width", cellSize)
                        .attr("height", cellSize)
                        .attr("x", d => d3.timeWeek.count(d3.timeYear(d.date), d.date) * cellSize)
                        .attr("y", d => d.date.getDay() * cellSize)
                        .attr("fill", d => color(d.value))
                        .on("mouseover", (event, d) => {
                            tooltip.transition().duration(200).style("opacity", 0.9);
                            tooltip.html(`${formatDate(d.date)}<br/>${d.value} atividades`)
                                .style("left", (event.pageX + 10) + "px")
                                .style("top", (event.pageY - 20) + "px");
                        })
                        .on("mouseout", () => {
                            tooltip.transition().duration(500).style("opacity", 0);
                        }),
                    update => update.transition().duration(300).attr("fill", d => color(d.value))
                );
        }

        // Atualiza sempre que o localStorage mudar (inclusive entre abas)
        window.addEventListener("storage", () => updateHeatmap());

        updateHeatmap();
    </script>

</body>

</html>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        document.body.classList.add('loaded');
    });
</script>