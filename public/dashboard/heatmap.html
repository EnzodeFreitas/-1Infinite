<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Heatmap</title>
  <style>
    svg { font-family: sans-serif; }
    .day-label { font-size: 10px; fill: #555; }
    .tooltip {
      position: absolute;
      text-align: center;
      padding: 5px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 3px;
      pointer-events: none;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h2>Atividades por Dia</h2>
  <div id="heatmap"></div>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="data.js"></script>

  <script>
    const width = 1000, height = 150, cellSize = 17;
    const svg = d3.select("#heatmap").append("svg")
      .attr("width", width)
      .attr("height", height);
    const g = svg.append("g").attr("transform", "translate(40,20)");
    const color = d3.scaleQuantize()
      .domain([0, 10])
      .range(["#ebedf0", "#c6e48b", "#7bc96f", "#239a3b", "#196127"]);
    const dayLabels = ["D", "S", "T", "Q", "Q", "S", "S"];
    const tooltip = d3.select("body").append("div")
      .attr("class", "tooltip").style("opacity", 0);

    g.selectAll(".day-label")
      .data(dayLabels)
      .join("text")
      .attr("class", "day-label")
      .attr("x", -5)
      .attr("y", (d, i) => i * cellSize + 12)
      .attr("text-anchor", "end")
      .text(d => d);

    g.selectAll(".month")
      .data(d3.timeMonths(new Date(year, 0, 1), new Date(year + 1, 0, 1)))
      .join("text")
      .attr("x", d => d3.timeWeek.count(d3.timeYear(d), d) * cellSize)
      .attr("y", -5)
      .text(d3.timeFormat("%b"));

    const allDates = d3.timeDays(new Date(year, 0, 1), new Date(year + 1, 0, 1));
    let heatmapData = allDates.map(d => ({ date: d, value: 0 }));

    function updateHeatmap() {
      const stored = JSON.parse(localStorage.getItem('userActivityByDate'));
       console.log("stored:", stored);
      heatmapData.forEach(d => {
        const key = formatDate(d.date);
        d.value = stored[key] || 0;
      });

      g.selectAll("rect.day")
        .data(heatmapData, d => formatDate(d.date))
        .join(
          enter => enter.append("rect")
            .attr("class", "day")
            .attr("width", cellSize)
            .attr("height", cellSize)
            .attr("x", d => d3.timeWeek.count(d3.timeYear(d.date), d.date) * cellSize)
            .attr("y", d => d.date.getDay() * cellSize)
            .attr("fill", d => color(d.value))
            .on("mouseover", (event, d) => {
              tooltip.transition().duration(200).style("opacity", 0.9);
              tooltip.html(`${formatDate(d.date)}<br/>${d.value} atividades`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 20) + "px");
            })
            .on("mouseout", () => {
              tooltip.transition().duration(500).style("opacity", 0);
            }),
          update => update.transition().duration(300).attr("fill", d => color(d.value))
        );
    }

    // Atualiza sempre que o localStorage mudar (inclusive entre abas)
    window.addEventListener("storage", () => updateHeatmap());

    updateHeatmap();
  </script>
</body>
</html>
